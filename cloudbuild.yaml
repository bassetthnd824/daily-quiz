steps:
  # Step 1: Build the Docker image
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash' 
    args:
      - '-c'
      - |
        docker build -t ${_DEPLOY_REGION}-docker.pkg.dev/${PROJECT_ID}/${_AR_REPOSITORY}/daily-quiz:${COMMIT_SHA} \
        --secret id=FIREBASE_SERVICE_ACCOUNT,env=FIREBASE_SERVICE_ACCOUNT \
        --secret id=NEXT_PUBLIC_FIREBASE_API_KEY,env=NEXT_PUBLIC_FIREBASE_API_KEY \
        --secret id=NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN,env=NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN \
        --secret id=NEXT_PUBLIC_FIREBASE_PROJECT_ID,env=NEXT_PUBLIC_FIREBASE_PROJECT_ID \
        --secret id=NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,env=NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET \
        --secret id=NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID,env=NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID \
        --secret id=NEXT_PUBLIC_FIREBASE_APP_ID,env=NEXT_PUBLIC_FIREBASE_APP_ID \
        .
    secretEnv: 
      - 'FIREBASE_SERVICE_ACCOUNT'
      - 'NEXT_PUBLIC_FIREBASE_API_KEY'
      - 'NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN'
      - 'NEXT_PUBLIC_FIREBASE_PROJECT_ID'
      - 'NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET'
      - 'NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID'
      - 'NEXT_PUBLIC_FIREBASE_APP_ID'

    env:
      - "DOCKER_BUILDKIT=1" # Enable Docker BuildKit

  # Step 2: Push the Docker image to Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - '${_DEPLOY_REGION}-docker.pkg.dev/${PROJECT_ID}/${_AR_REPOSITORY}/daily-quiz:${COMMIT_SHA}'

  # Step 3: Deploy the image to Cloud Run
  - name: 'gcr.io/cloud-builders/gcloud'
    args:
      - 'run'
      - 'deploy'
      - '${_SERVICE_NAME}'
      - '--image'
      - '${_DEPLOY_REGION}-docker.pkg.dev/${PROJECT_ID}/${_AR_REPOSITORY}/daily-quiz:${COMMIT_SHA}'
      - '--region'
      - '${_DEPLOY_REGION}'
      - '--allow-unauthenticated' # Optional: Allow public access
      - '--port'
      - '3000' # Next.js default port

availableSecrets:
  secretManager:
  - versionName: projects/daily-quiz-464300/secrets/FIREBASE_SERVICE_ACCOUNT/versions/latest
    env: 'FIREBASE_SERVICE_ACCOUNT'
  - versionName: projects/daily-quiz-464300/secrets/NEXT_PUBLIC_FIREBASE_API_KEY/versions/latest
    env: 'NEXT_PUBLIC_FIREBASE_API_KEY'
  - versionName: projects/daily-quiz-464300/secrets/NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN/versions/latest
    env: 'NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN'
  - versionName: projects/daily-quiz-464300/secrets/NEXT_PUBLIC_FIREBASE_PROJECT_ID/versions/latest
    env: 'NEXT_PUBLIC_FIREBASE_PROJECT_ID'
  - versionName: projects/daily-quiz-464300/secrets/NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET/versions/latest
    env: 'NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET'
  - versionName: projects/daily-quiz-464300/secrets/NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID/versions/latest
    env: 'NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID'
  - versionName: projects/daily-quiz-464300/secrets/NEXT_PUBLIC_FIREBASE_APP_ID/versions/latest
    env: 'NEXT_PUBLIC_FIREBASE_APP_ID'
options:
  logging: CLOUD_LOGGING_ONLY # <--- Add this section

  
